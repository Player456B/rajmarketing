<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Estimate Form | Raj Marketing</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary: #0e2a47;
      --secondary: #3bb4f2;
      --dark-yellow: #ffd600;
      --gold: #ffd700;
      --white: #fff;
      --shadow: 0 2px 14px rgba(30,40,80,0.16);
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f7fbff;
      margin: 0;
      padding: 0;
      color: #222;
    }
    .estimate-wrapper {
      max-width: 880px;
      margin: 2em auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 2em 2.2em 2.5em 2.2em;
      position: relative;
    }
    .estimate-header {
      display: flex;
      align-items: center;
      border-bottom: 2px solid #eaeaea;
      padding-bottom: 1.5em;
      margin-bottom: 2em;
    }
    .estimate-logo {
      width: 85px;
      height: 85px;
      object-fit: contain;
      margin-right: 2em;
    }
    .estimate-title-group {
      flex: 1;
    }
    .estimate-title {
      font-size: 2em;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.3em;
    }
    .estimate-id {
      font-weight: 600;
      color: var(--secondary);
      font-size: 1.08em;
    }
    .estimate-form-section {
      margin-bottom: 2em;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.3em;
      margin-bottom: 1.2em;
    }
    .form-group {
      flex: 1 1 200px;
      min-width: 180px;
      margin-bottom: 0.5em;
    }
    .form-group label {
      font-weight: 600;
      color: var(--primary);
      font-size: 1em;
      display: block;
      margin-bottom: 0.27em;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.45em 0.7em;
      border-radius: 7px;
      border: 1px solid #c8e3fa;
      font-size: 1em;
      background: #f8fcff;
      color: #1b2e4b;
      outline: none;
      box-sizing: border-box;
      transition: border .17s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border: 1.5px solid var(--secondary);
    }
    .estimate-table-section {
      margin-bottom: 2em;
    }
    .estimate-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1em;
      margin-bottom: 0.7em;
      background: #f8fcff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 8px #0001;
    }
    .estimate-table th, .estimate-table td {
      border: 1px solid #e3ebf7;
      padding: 0.6em 0.7em;
      text-align: center;
    }
    .estimate-table th {
      background: var(--primary);
      color: var(--white);
      font-weight: 700;
      font-size: 1.01em;
    }
    .estimate-table td input,
    .estimate-table td select {
      width: 90%;
      padding: 0.3em 0.5em;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #d7eafd;
      background: #fff;
      color: #14345b;
      text-align: center;
    }
    .add-row-btn {
      margin-top: 0.4em;
      background: var(--secondary);
      color: #fff;
      border: none;
      padding: 0.43em 1.1em;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      transition: background .18s;
      box-shadow: 0 2px 8px #0002;
    }
    .add-row-btn:hover {
      background: #1e8fd1;
    }
    .calc-btn {
      margin-top: 1.3em;
      background: var(--dark-yellow);
      color: var(--primary);
      border: none;
      padding: 0.65em 2.1em;
      border-radius: 8px;
      font-size: 1.12em;
      cursor: pointer;
      font-weight: 700;
      transition: background .18s;
      box-shadow: 0 2px 15px #ffd60033;
      display: block;
      margin-left: auto;
    }
    .totals-box {
      margin-top: 1.4em;
      padding: 1.1em 1.2em;
      background: #f7f8fd;
      border-radius: 9px;
      box-shadow: 0 2px 8px #0001;
      font-size: 1.1em;
      color: #19344c;
      max-width: 410px;
      margin-left: auto;
    }
    .totals-box label {
      font-weight: 600;
      color: var(--primary);
    }
    .totals-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5em;
    }
    .data-preview {
      margin: 2em 0 0 0;
      background: #fff;
      border-radius: 12px;
      padding: 2em;
      box-shadow: 0 2px 18px #0001;
    }
    .pdf-btn {
      display: inline-block;
      margin-top: 1.3em;
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.7em 2.1em;
      border-radius: 8px;
      font-size: 1.07em;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 2px 12px #0e2a4722;
      transition: background .18s;
    }
    .pdf-btn:hover {
      background: var(--secondary);
    }
    @media (max-width: 600px) {
      .estimate-wrapper { padding: 1em 0.2em; }
      .estimate-header { flex-direction: column; align-items: flex-start;}
      .estimate-logo { margin-bottom: 1em; }
      .data-preview {padding: 1em;}
      .totals-box {padding: 0.7em 0.3em;}
    }
  </style>
</head>
<body>
  <div class="estimate-wrapper">
    <div class="estimate-header">
      <img src="https://raw.githubusercontent.com/Player456B/rajmarketing/main/assets/images/logo.svg" alt="Raj Marketing Logo" class="estimate-logo">
      <div class="estimate-title-group">
        <div class="estimate-title">Estimate Form</div>
        <div class="estimate-id" id="estId"></div>
      </div>
    </div>
    <form id="estForm" autocomplete="off">
      <div class="estimate-form-section">
        <div class="form-row">
          <div class="form-group">
            <label for="cId">Customer ID</label>
            <input type="text" id="cId" name="customerId" readonly placeholder="Auto">
          </div>
          <div class="form-group">
            <label for="cName">Customer Name</label>
            <input type="text" id="cName" name="customerName" required>
          </div>
          <div class="form-group">
            <label for="cPhone">Phone Number</label>
            <input type="tel" id="cPhone" name="customerPhone" pattern="[0-9]{10,}" required>
          </div>
          <div class="form-group">
            <label for="cAddress">Address</label>
            <textarea id="cAddress" name="customerAddress" rows="1" required></textarea>
          </div>
          <div class="form-group">
            <label for="estDate">Estimate Date</label>
            <input type="date" id="estDate" name="estimateDate" required>
          </div>
        </div>
      </div>
      <div class="estimate-table-section">
        <table class="estimate-table" id="estTable">
          <thead>
            <tr>
              <th>Sl. No.</th>
              <th>Types of Nets</th>
              <th>Width (inches)</th>
              <th>Height (inches)</th>
              <th>Qty</th>
              <th>Sqft</th>
              <th>Price (₹)</th>
              <th>Remove</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- rows go here -->
          </tbody>
        </table>
        <button type="button" class="add-row-btn" onclick="addRow()">+ Add Row</button>
      </div>
      <button type="button" class="calc-btn" onclick="calculateEstimate()">Calculate & Preview</button>
      <div class="totals-box" id="totalsBox" style="display:none;">
        <div class="totals-row"><label>Total Quantity:</label><span id="totalQty"></span></div>
        <div class="totals-row"><label>Total Sqft:</label><span id="totalSqft"></span></div>
        <div class="totals-row"><label>Total Price:</label><span id="totalPrice"></span></div>
        <div class="totals-row"><label>GST (18%):</label><span id="gst"></span></div>
        <div class="totals-row"><label>Discount (%):</label>
          <input type="number" id="discountPercent" min="0" max="100" value="0" style="width:60px;" onchange="calculateEstimate()">
        </div>
        <div class="totals-row"><label><b>Final Price:</b></label><span id="finalPrice" style="font-weight:700;color:var(--secondary)"></span></div>
      </div>
    </form>
    <div class="data-preview" id="previewBox" style="display:none;"></div>
    <button class="pdf-btn" id="toPdfBtn" style="display:none;" onclick="downloadPDF()">Download PDF</button>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Pricing per net type
    const netTypes = [
      {label: "Velcro System", price: 60},
      {label: "Frame System", price: 180},
      {label: "Pleated Nets", price: 350},
      {label: "Fly mesh Door", price: 380}
    ];
    // Try to auto-fill customer info if available in localStorage (simulate rajmarketing)
    let users = JSON.parse(localStorage.getItem('raj_users')||'[]');
    let logged = localStorage.getItem('raj_loggedin');
    let user = users.find(u=>u.phone===logged);
    if(user) {
      document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('cId').value = user.id || '';
        document.getElementById('cName').value = user.name || '';
        document.getElementById('cPhone').value = user.phone || '';
        document.getElementById('cAddress').value = user.address || '';
      });
    } else {
      document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('cId').value = '';
        document.getElementById('cName').value = '';
        document.getElementById('cPhone').value = '';
        document.getElementById('cAddress').value = '';
      });
    }
    // Estimate ID generation
    function genEstimateId() {
      const now = new Date();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const rand = String(Math.floor(Math.random()*9000)+1000);
      return `${mm}${dd}-${rand}`;
    }
    document.getElementById('estId').textContent = "Estimate ID: " + genEstimateId();
    document.getElementById('estDate').valueAsDate = new Date();

    // Table logic
    function addRow(typeIdx=0) {
      const table = document.getElementById('tableBody');
      const tr = document.createElement('tr');
      const rowIdx = table.children.length+1;
      tr.innerHTML = `
        <td>${rowIdx}</td>
        <td>
          <select class="netType" onchange="updateRow(this)">
            ${netTypes.map((nt,i)=>`<option value="${i}">${nt.label} (₹${nt.price}/Sqft)</option>`).join('')}
          </select>
        </td>
        <td><input type="number" min="1" max="500" class="width" onchange="updateRow(this)" required></td>
        <td><input type="number" min="1" max="500" class="height" onchange="updateRow(this)" required></td>
        <td><input type="number" min="1" max="100" class="qty" onchange="updateRow(this)" required></td>
        <td><input type="text" class="sqft" readonly></td>
        <td><input type="text" class="price" readonly></td>
        <td><button type="button" onclick="removeRow(this)" style="background:#ef4444;color:#fff;border:none;padding:0.4em 0.7em;border-radius:5px;cursor:pointer;">✖</button></td>
      `;
      tr.querySelector('.netType').selectedIndex = typeIdx;
      table.appendChild(tr);
    }
    function removeRow(btn) {
      btn.closest('tr').remove();
      // Renumber
      Array.from(document.getElementById('tableBody').children).forEach((tr,i)=>{
        tr.children[0].textContent = i+1;
      });
    }
    function updateRow(anyInput) {
      const tr = anyInput.closest('tr');
      const typeIdx = +tr.querySelector('.netType').value;
      let w = +tr.querySelector('.width').value;
      let h = +tr.querySelector('.height').value;
      let qty = +tr.querySelector('.qty').value;
      if(isNaN(w)||isNaN(h)||isNaN(qty)||!w||!h||!qty) {
        tr.querySelector('.sqft').value = '';
        tr.querySelector('.price').value = '';
        return;
      }
      if(w<24) w = 24;
      if(h<24) h = 24;
      const sqft = ((w*h)/144)*qty;
      const price = sqft * netTypes[typeIdx].price;
      tr.querySelector('.sqft').value = sqft.toFixed(2);
      tr.querySelector('.price').value = price.toFixed(2);
    }
    // Add one row by default
    document.addEventListener('DOMContentLoaded',()=>addRow());

    // Calculate logic
    function calculateEstimate() {
      // Validate required
      let valid = true;
      ['cName','cPhone','cAddress','estDate'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el.value) { el.style.border='1.5px solid red'; valid=false; }
        else { el.style.border='1px solid #c8e3fa'; }
      });
      if(!valid) { alert('Fill all required fields!'); return; }
      // Collect table data
      const rows = Array.from(document.getElementById('tableBody').children);
      let totalQty = 0, totalSqft = 0, totalPrice = 0;
      let tableData = [];
      rows.forEach((tr,i)=>{
        const typeIdx = +tr.querySelector('.netType').value;
        let w = +tr.querySelector('.width').value;
        let h = +tr.querySelector('.height').value;
        let qty = +tr.querySelector('.qty').value;
        if(w<24) w=24;
        if(h<24) h=24;
        if(!w||!h||!qty) return;
        const sqft = ((w*h)/144)*qty;
        const price = sqft * netTypes[typeIdx].price;
        totalQty += qty;
        totalSqft += sqft;
        totalPrice += price;
        tableData.push({
          sl:i+1,
          type: netTypes[typeIdx].label,
          width: w,
          height: h,
          qty: qty,
          sqft: sqft,
          unitPrice: netTypes[typeIdx].price,
          price: price
        });
        tr.querySelector('.sqft').value = sqft.toFixed(2);
        tr.querySelector('.price').value = price.toFixed(2);
      });
      // Totals
      const gst = totalPrice*0.18;
      const discount = +document.getElementById('discountPercent').value||0;
      const afterDiscount = totalPrice * (1 - discount/100);
      const finalPrice = afterDiscount + (afterDiscount*0.18);

      document.getElementById('totalsBox').style.display = '';
      document.getElementById('totalQty').textContent = totalQty;
      document.getElementById('totalSqft').textContent = totalSqft.toFixed(2);
      document.getElementById('totalPrice').textContent = "₹" + totalPrice.toFixed(2);
      document.getElementById('gst').textContent = "₹" + (afterDiscount*0.18).toFixed(2);
      document.getElementById('finalPrice').textContent = "₹" + finalPrice.toFixed(2);

      // Data preview
      let preview = `
        <h2 style="color:var(--primary)">Estimate Preview</h2>
        <div style="display:flex;align-items:flex-start;gap:2em;">
          <div>
            <b>Customer Name:</b> ${document.getElementById('cName').value}<br>
            <b>Phone:</b> ${document.getElementById('cPhone').value}<br>
            <b>Address:</b> ${document.getElementById('cAddress').value}<br>
            <b>Date:</b> ${document.getElementById('estDate').value}<br>
            <b>Estimate ID:</b> ${document.getElementById('estId').textContent.replace("Estimate ID: ","")}<br>
          </div>
        </div>
        <table border="1" cellpadding="6" style="margin:1.3em 0 0 0;width:100%;border-collapse:collapse;background:#fff;font-size:1em;">
          <tr style="background:var(--primary);color:#fff;">
            <th>Sl.No.</th>
            <th>Type</th>
            <th>Width (in)</th>
            <th>Height (in)</th>
            <th>Qty</th>
            <th>Sqft</th>
            <th>Unit Price</th>
            <th>Price (₹)</th>
          </tr>
          ${tableData.map(row=>`
            <tr>
              <td>${row.sl}</td>
              <td>${row.type}</td>
              <td>${row.width}</td>
              <td>${row.height}</td>
              <td>${row.qty}</td>
              <td>${row.sqft.toFixed(2)}</td>
              <td>₹${row.unitPrice}</td>
              <td>₹${row.price.toFixed(2)}</td>
            </tr>
          `).join('')}
        </table>
        <div style="margin-top:1.1em;max-width:350px;">
          <div><b>Total Qty:</b> ${totalQty}</div>
          <div><b>Total Sqft:</b> ${totalSqft.toFixed(2)}</div>
          <div><b>Total Price:</b> ₹${totalPrice.toFixed(2)}</div>
          <div><b>Discount:</b> ${discount}% (₹${(totalPrice*discount/100).toFixed(2)})</div>
          <div><b>Sub Total:</b> ₹${afterDiscount.toFixed(2)}</div>
          <div><b>GST(18%):</b> ₹${(afterDiscount*0.18).toFixed(2)}</div>
          <div style="font-size:1.15em;color:var(--secondary);font-weight:700;"><b>Final Price (Incl. GST):</b> ₹${finalPrice.toFixed(2)}</div>
        </div>
      `;
      document.getElementById('previewBox').innerHTML = preview;
      document.getElementById('previewBox').style.display = '';
      document.getElementById('toPdfBtn').style.display = '';
    }

    // Listen for manual edits in table to update values
    document.getElementById('tableBody').addEventListener('input', function(e){
      updateRow(e.target);
    });

    // PDF logic
    function downloadPDF() {
      const preview = document.getElementById('previewBox');
      html2canvas(preview, {scale:2}).then(canvas=>{
        const imgData = canvas.toDataURL('image/png', 1.0);
        const pdf = new window.jspdf.jsPDF({
          orientation: 'portrait',
          unit: 'pt',
          format: 'a4'
        });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        let imgWidth = pageWidth-40;
        let imgHeight = canvas.height * imgWidth / canvas.width;
        pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight, '', 'FAST');
        pdf.save('Estimate-'+ document.getElementById('estId').textContent.replace("Estimate ID: ","") +'.pdf');
      });
    }
  </script>
</body>
</html>
