<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Estimate Form | Raj Marketing</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #191970;
      --secondary: #1fc8db;
      --accent: #f9d423;
      --white: #fff;
      --gray: #f6f8fa;
      --shadow: 0 4px 24px rgba(25,25,112,0.08);
      --border-radius: 16px;
      --spacing: 1.25em;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(120deg, #fdfcfb 0%, #e2d1c3 100%);
      color: #23213d;
      min-height: 100vh;
    }
    .estimate-container {
      max-width: 650px;
      margin: 2em auto;
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      padding: 0;
      transition: box-shadow .2s;
    }
    .estimate-header {
      background: linear-gradient(90deg, var(--primary) 60%, var(--secondary) 100%);
      color: var(--white);
      padding: 2em 1.4em 1.3em 1.4em;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
    }
    .estimate-logo {
      width: 64px;
      height: 64px;
      object-fit: contain;
      border-radius: 10px;
      box-shadow: 0 2px 10px #0002;
      background: #fff;
      margin-bottom: 1em;
    }
    .estimate-title {
      font-size: 2em;
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-bottom: 0.15em;
      text-shadow: 0 1px 6px #0002;
    }
    .estimate-id-date {
      font-size: 1em;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 0.3em;
      letter-spacing: 0.03em;
    }
    form {
      padding: 2em 1.4em 1.2em 1.4em;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2em;
      margin-bottom: 1.1em;
    }
    .form-group {
      flex: 1 1 180px;
      min-width: 150px;
      margin-bottom: 0.4em;
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 0.23em;
      color: var(--primary);
      font-size: 1em;
      letter-spacing: 0.01em;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.5em 0.8em;
      border-radius: 7px;
      border: 1.4px solid #c3d6ef;
      font-size: 1em;
      background: #f5fafc;
      color: #1b2e4b;
      outline: none;
      transition: border .17s;
      font-family: inherit;
      resize: none;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border: 1.6px solid var(--secondary);
    }
    .estimate-table-section {
      margin-bottom: 1.2em;
      overflow-x: auto;
    }
    .estimate-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1em;
      margin-bottom: 0.6em;
      background: var(--gray);
      border-radius: 9px;
      overflow: hidden;
      min-width: 650px;
      box-shadow: 0 1px 8px #0001;
    }
    .estimate-table th, .estimate-table td {
      border: 1px solid #e0eafc;
      padding: 0.5em 0.4em;
      text-align: center;
    }
    .estimate-table th {
      background: linear-gradient(90deg,#1fc8db .8%,#191970 90%);
      color: #fff;
      font-weight: 700;
      font-size: 1.01em;
      letter-spacing: 0.01em;
    }
    .estimate-table td input,
    .estimate-table td select {
      width: 100%;
      padding: 0.3em 0.5em;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #d7eafd;
      background: #fff;
      color: #14345b;
      text-align: center;
    }
    .add-row-btn {
      margin: 0.6em 0;
      background: var(--secondary);
      color: #fff;
      border: none;
      padding: 0.45em 1.2em;
      border-radius: 7px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      transition: background .18s;
      box-shadow: 0 2px 8px #0002;
      display: flex;
      align-items: center;
      gap: 0.4em;
    }
    .add-row-btn .material-icons {
      font-size: 1.3em;
      vertical-align: middle;
    }
    .add-row-btn:hover { background: #109cb9; }
    .calc-btn {
      margin-top: 1em;
      background: var(--accent);
      color: var(--primary);
      border: none;
      padding: 0.65em 2em;
      border-radius: 8px;
      font-size: 1.13em;
      cursor: pointer;
      font-weight: 700;
      transition: background .18s;
      box-shadow: 0 2px 15px #ffd60033;
      display: block;
      margin-left: auto;
      margin-right: 0;
    }
    .calc-btn:hover { background: #fcbb03; }
    .totals-box {
      margin-top: 1.3em;
      padding: 1.1em 1em 1em 1em;
      background: linear-gradient(90deg, #e7f2ff 60%, #e2d1c3 100%);
      border-radius: 9px;
      box-shadow: 0 2px 8px #0001;
      font-size: 1.08em;
      color: #19344c;
      max-width: 420px;
      margin-left: auto;
      margin-right: 0;
    }
    .totals-box label {
      font-weight: 600;
      color: var(--primary);
    }
    .totals-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.45em;
    }
    .totals-row input[type="number"] {
      width: 70px;
      margin-left: 8px;
      font-size: 1em;
    }
    .data-preview {
      margin: 2em 0 0 0;
      background: #fafbf9;
      border-radius: 12px;
      padding: 1.85em 1.1em 1.2em 1.1em;
      box-shadow: 0 2px 18px #0001;
      font-size: 1.03em;
      /* limit width for mobile pdf rendering */
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .pdf-btn {
      display: inline-block;
      margin-top: 1.3em;
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.7em 2.1em;
      border-radius: 10px;
      font-size: 1.07em;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 2px 12px #0e2a4722;
      transition: background .18s;
      margin-left: auto;
      margin-right: 0;
    }
    .pdf-btn:hover { background: var(--secondary);}
    .table-scroll { overflow-x: auto; }
    .remove-row-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 0.28em 0.62em;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.2em;
      display: inline-flex;
      align-items: center;
      transition: background .16s;
    }
    .remove-row-btn:hover { background: #bc1c1c; }

    /* Responsive styles overhaul */
    @media (max-width: 900px) {
      .estimate-container { max-width: 99vw; }
      .data-preview { max-width: 99vw; }
    }
    @media (max-width: 700px) {
      .estimate-container { max-width: 100vw; border-radius: 0; box-shadow: none;}
      .estimate-header { padding: 1.2em 0.8em 1em 0.8em; }
      form { padding: 1.3em 0.8em 0.9em 0.8em; }
      .data-preview { padding: 1em 0.3em; }
      .totals-box { padding: 0.7em 0.3em; }
      .estimate-table-section { margin-bottom: 1em; }
      .estimate-table { min-width: 540px; font-size: 0.92em; }
      .estimate-title { font-size: 1.25em; }
    }
    @media (max-width: 520px) {
      .form-row { flex-direction: column; gap: 0.7em;}
      .form-group {min-width: 100px;}
      .estimate-title { font-size: 1.1em;}
      .estimate-id-date { font-size: 0.92em;}
      .pdf-btn, .calc-btn { width: 100%; font-size: 1em;}
      .estimate-header,form {padding-left:0.4em;padding-right:0.4em;}
      .estimate-table { min-width: 400px; font-size: 0.85em;}
      .data-preview {padding:0.7em 0.18em;font-size:0.98em;}
    }
    @media (max-width: 400px) {
      .estimate-title { font-size: 0.95em;}
      .estimate-id-date { font-size: 0.85em;}
      .estimate-table { min-width: 300px;}
      .data-preview {font-size:0.93em;}
    }

    /* Table scroll for touch devices */
    .estimate-table-section { position: relative;}
    .estimate-table-section::-webkit-scrollbar { height: 6px; }
    .estimate-table-section::-webkit-scrollbar-thumb { background: #ddd; border-radius: 6px;}
    /* Hide number arrows for inputs on mobile */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body>
  <div class="estimate-container">
    <div class="estimate-header">
      <img src="https://raw.githubusercontent.com/Player456B/rajmarketing/main/assets/images/logo.svg" alt="Raj Marketing Logo" class="estimate-logo">
      <div class="estimate-title">Estimate Form</div>
      <div class="estimate-id-date" id="estId"></div>
    </div>
    <form id="estForm" autocomplete="off">
      <div class="form-row">
        <div class="form-group">
          <label for="cId">Customer ID</label>
          <input type="text" id="cId" name="customerId" readonly placeholder="Auto">
        </div>
        <div class="form-group">
          <label for="cName">Customer Name</label>
          <input type="text" id="cName" name="customerName" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="cPhone">Phone Number</label>
          <input type="tel" id="cPhone" name="customerPhone" pattern="[0-9]{10,}" required>
        </div>
        <div class="form-group">
          <label for="cAddress">Address</label>
          <textarea id="cAddress" name="customerAddress" rows="1" required></textarea>
        </div>
        <div class="form-group">
          <label for="estDate">Estimate Date</label>
          <input type="date" id="estDate" name="estimateDate" required>
        </div>
      </div>
      <div class="estimate-table-section table-scroll">
        <table class="estimate-table" id="estTable">
          <thead>
            <tr>
              <th>Sl. No.</th>
              <th>Types of Nets</th>
              <th>Width (in)</th>
              <th>Height (in)</th>
              <th>Qty</th>
              <th>Sqft</th>
              <th>Price (₹)</th>
              <th>Remove</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- JS Rows -->
          </tbody>
        </table>
        <button type="button" class="add-row-btn" onclick="addRow()"><span class="material-icons">add_circle_outline</span>Add Row</button>
      </div>
      <button type="button" class="calc-btn" onclick="calculateEstimate()">Calculate &amp; Preview</button>
      <div class="totals-box" id="totalsBox" style="display:none;">
        <div class="totals-row"><label>Total Quantity:</label><span id="totalQty"></span></div>
        <div class="totals-row"><label>Total Sqft:</label><span id="totalSqft"></span></div>
        <div class="totals-row"><label>Total Price:</label><span id="totalPrice"></span></div>
        <div class="totals-row"><label>GST (18%):</label><span id="gst"></span></div>
        <div class="totals-row"><label>Discount (%):</label>
          <input type="number" id="discountPercent" min="0" max="100" value="0" onchange="calculateEstimate()">
        </div>
        <div class="totals-row"><label><b>Final Price:</b></label><span id="finalPrice" style="font-weight:700;color:var(--secondary)"></span></div>
      </div>
    </form>
    <div class="data-preview" id="previewBox" style="display:none;"></div>
    <button class="pdf-btn" id="toPdfBtn" style="display:none;" onclick="downloadPDF()">Download PDF</button>
  </div>
  <!-- PDF Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Net types
    const netTypes = [
      {label: "Velcro System", price: 60},
      {label: "Frame System", price: 180},
      {label: "Pleated Nets", price: 350},
      {label: "Fly mesh Door", price: 380}
    ];
    // Prefill user
    let users = JSON.parse(localStorage.getItem('raj_users')||'[]');
    let logged = localStorage.getItem('raj_loggedin');
    let user = users.find(u=>u.phone===logged);
    document.addEventListener('DOMContentLoaded',()=>{
      if(user) {
        document.getElementById('cId').value = user.id || '';
        document.getElementById('cName').value = user.name || '';
        document.getElementById('cPhone').value = user.phone || '';
        document.getElementById('cAddress').value = user.address || '';
      }
      else {
        document.getElementById('cId').value = '';
        document.getElementById('cName').value = '';
        document.getElementById('cPhone').value = '';
        document.getElementById('cAddress').value = '';
      }
      document.getElementById('estDate').valueAsDate = new Date();
      document.getElementById('estId').textContent = "Estimate ID: " + genEstimateId() +
        " | Date: " + new Date().toLocaleDateString();
      addRow();
    });
    function genEstimateId() {
      const now = new Date();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const rand = String(Math.floor(Math.random()*9000)+1000);
      return `${mm}${dd}-${rand}`;
    }
    // Table logic
    function addRow(typeIdx=0) {
      const table = document.getElementById('tableBody');
      const tr = document.createElement('tr');
      const rowIdx = table.children.length+1;
      tr.innerHTML = `
        <td>${rowIdx}</td>
        <td>
          <select class="netType" onchange="updateRow(this)">
            ${netTypes.map((nt,i)=>`<option value="${i}">${nt.label} (₹${nt.price}/Sqft)</option>`).join('')}
          </select>
        </td>
        <td><input type="number" min="1" max="500" class="width" onchange="updateRow(this)" required></td>
        <td><input type="number" min="1" max="500" class="height" onchange="updateRow(this)" required></td>
        <td><input type="number" min="1" max="100" class="qty" onchange="updateRow(this)" required></td>
        <td><input type="text" class="sqft" readonly></td>
        <td><input type="text" class="price" readonly></td>
        <td>
          <button type="button" class="remove-row-btn" title="Remove Row" onclick="removeRow(this)">
            <span class="material-icons" aria-label="remove row">delete_outline</span>
          </button>
        </td>
      `;
      tr.querySelector('.netType').selectedIndex = typeIdx;
      table.appendChild(tr);
    }
    function removeRow(btn) {
      btn.closest('tr').remove();
      // Renumber
      Array.from(document.getElementById('tableBody').children).forEach((tr,i)=>{
        tr.children[0].textContent = i+1;
      });
    }
    function updateRow(anyInput) {
      const tr = anyInput.closest('tr');
      const typeIdx = +tr.querySelector('.netType').value;
      let w = +tr.querySelector('.width').value;
      let h = +tr.querySelector('.height').value;
      let qty = +tr.querySelector('.qty').value;
      if(isNaN(w)||isNaN(h)||isNaN(qty)||!w||!h||!qty) {
        tr.querySelector('.sqft').value = '';
        tr.querySelector('.price').value = '';
        return;
      }
      if(w<24) w = 24;
      if(h<24) h = 24;
      const sqft = ((w*h)/144)*qty;
      const price = sqft * netTypes[typeIdx].price;
      tr.querySelector('.sqft').value = sqft.toFixed(2);
      tr.querySelector('.price').value = price.toFixed(2);
    }
    // Listen for manual edits in table to update values
    document.getElementById('tableBody').addEventListener('input', function(e){
      updateRow(e.target);
    });
    // Calculate logic
    function calculateEstimate() {
      // Validate required
      let valid = true;
      ['cName','cPhone','cAddress','estDate'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el.value) { el.style.border='1.5px solid red'; valid=false; }
        else { el.style.border='1px solid #c8e3fa'; }
      });
      if(!valid) { alert('Fill all required fields!'); return; }
      // Collect table data
      const rows = Array.from(document.getElementById('tableBody').children);
      let totalQty = 0, totalSqft = 0, totalPrice = 0;
      let tableData = [];
      rows.forEach((tr,i)=>{
        const typeIdx = +tr.querySelector('.netType').value;
        let w = +tr.querySelector('.width').value;
        let h = +tr.querySelector('.height').value;
        let qty = +tr.querySelector('.qty').value;
        if(w<24) w=24;
        if(h<24) h=24;
        if(!w||!h||!qty) return;
        const sqft = ((w*h)/144)*qty;
        const price = sqft * netTypes[typeIdx].price;
        totalQty += qty;
        totalSqft += sqft;
        totalPrice += price;
        tableData.push({
          sl:i+1,
          type: netTypes[typeIdx].label,
          width: w,
          height: h,
          qty: qty,
          sqft: sqft,
          unitPrice: netTypes[typeIdx].price,
          price: price
        });
        tr.querySelector('.sqft').value = sqft.toFixed(2);
        tr.querySelector('.price').value = price.toFixed(2);
      });
      // Totals
      const discount = +document.getElementById('discountPercent').value||0;
      const afterDiscount = totalPrice * (1 - discount/100);
      const gst = afterDiscount * 0.18;
      const finalPrice = afterDiscount + gst;
      document.getElementById('totalsBox').style.display = '';
      document.getElementById('totalQty').textContent = totalQty;
      document.getElementById('totalSqft').textContent = totalSqft.toFixed(2);
      document.getElementById('totalPrice').textContent = "₹" + totalPrice.toFixed(2);
      document.getElementById('gst').textContent = "₹" + gst.toFixed(2);
      document.getElementById('finalPrice').textContent = "₹" + finalPrice.toFixed(2);
      // Data preview (improved for mobile/pdf)
      let preview = `
        <div style="display:flex;align-items:center;gap:1.1em;flex-wrap:wrap;margin-bottom:0.7em;">
          <img src="https://raw.githubusercontent.com/Player456B/rajmarketing/main/assets/images/logo.svg" style="width:54px;height:54px;object-fit:contain;border-radius:9px;box-shadow:0 2px 9px #0002;flex-shrink:0;">
          <div>
            <span style="font-size:1.12em;font-weight:700;color:#191970;letter-spacing:0.01em;">Estimate Preview</span><br>
            <span style="font-size:0.92em;color:#1fc8db;font-weight:600">${document.getElementById('estId').textContent}</span>
          </div>
        </div>
        <div style="margin:0.8em 0 0.5em 0;line-height:1.5;font-size:0.99em;">
          <b>Customer Name:</b> ${document.getElementById('cName').value}<br>
          <b>Phone:</b> ${document.getElementById('cPhone').value}<br>
          <b>Address:</b> ${document.getElementById('cAddress').value}<br>
          <b>Date:</b> ${document.getElementById('estDate').value}<br>
        </div>
        <div style="overflow-x:auto;">
        <table border="1" cellpadding="5" style="margin:0.7em 0;width:100%;border-collapse:collapse;background:#fff;font-size:0.97em;min-width:320px;">
          <tr style="background:linear-gradient(90deg,#1fc8db .8%,#191970 90%);color:#fff;">
            <th>Sl.No.</th>
            <th>Type</th>
            <th>W</th>
            <th>H</th>
            <th>Qty</th>
            <th>Sqft</th>
            <th>Unit Price</th>
            <th>Price (₹)</th>
          </tr>
          ${tableData.map(row=>`
            <tr>
              <td>${row.sl}</td>
              <td>${row.type}</td>
              <td>${row.width}</td>
              <td>${row.height}</td>
              <td>${row.qty}</td>
              <td>${row.sqft.toFixed(2)}</td>
              <td>₹${row.unitPrice}</td>
              <td>₹${row.price.toFixed(2)}</td>
            </tr>
          `).join('')}
        </table>
        </div>
        <div style="margin-top:0.5em;max-width:330px;font-size:0.98em;">
          <div><b>Total Qty:</b> ${totalQty}</div>
          <div><b>Total Sqft:</b> ${totalSqft.toFixed(2)}</div>
          <div><b>Total Price:</b> ₹${totalPrice.toFixed(2)}</div>
          <div><b>Discount:</b> ${discount}% (₹${(totalPrice*discount/100).toFixed(2)})</div>
          <div><b>Sub Total:</b> ₹${afterDiscount.toFixed(2)}</div>
          <div><b>GST(18%):</b> ₹${gst.toFixed(2)}</div>
          <div style="font-size:1.05em;color:#1fc8db;font-weight:700;"><b>Final Price (Incl. GST):</b> ₹${finalPrice.toFixed(2)}</div>
        </div>
        <div style="margin-top:1.2em;font-size:0.93em;color:#888;">Thank you for choosing <b>Raj Marketing</b>!</div>
      `;
      document.getElementById('previewBox').innerHTML = preview;
      document.getElementById('previewBox').style.display = '';
      document.getElementById('toPdfBtn').style.display = '';
    }
    // PDF logic: single-page fit for A4 and mobile
    function downloadPDF() {
      const preview = document.getElementById('previewBox');
      // Set width for single A4 page (portrait, 595pt width)
      const pdfWidth = 575; // a4 width minus margin
      html2canvas(preview, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#fff",
        width: preview.scrollWidth,
        windowWidth: preview.scrollWidth
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png', 1.0);
        const pdf = new window.jspdf.jsPDF({
          orientation: 'portrait',
          unit: 'pt',
          format: 'a4'
        });
        // Fit image to page width (a4 width: 595pt, margin: 10pt)
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        let imgWidth = pdfWidth;
        let imgHeight = canvas.height * (imgWidth / canvas.width);
        // If image too tall, scale down height to fit one page
        if (imgHeight > pageHeight - 30) {
          imgHeight = pageHeight - 30;
          imgWidth = canvas.width * (imgHeight / canvas.height);
        }
        // Center image horizontally
        const xOffset = (pageWidth - imgWidth) / 2;
        pdf.addImage(imgData, 'PNG', xOffset, 15, imgWidth, imgHeight, '', 'FAST');
        pdf.save('Estimate-' + document.getElementById('estId').textContent.replace("Estimate ID: ", "").split('|')[0].trim() + '.pdf');
      });
    }
  </script>
</body>
</html>
